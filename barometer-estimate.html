<div class="readout">
  <p>Lat: <span id="latitude">—</span></p>
  <p>Lon: <span id="longitude">—</span></p>
  <p>Elevation: <span id="elevation">—</span></p>
  <p>Pressure: <span id="pressure">—</span></p>
  <p id="status" style="font-size:0.95rem;color:#555">Tap the button to estimate.</p>
  <button onclick="getPressureEstimate()">Get Pressure Estimate</button>
</div>

<script>
  function $(id){ return document.getElementById(id); }
  function estimatePressure(elevationMeters) {
    const seaLevelPressure = 1013.25; // hPa
    return (seaLevelPressure * Math.pow((1 - (0.0065 * elevationMeters) / 288.15), 5.255)).toFixed(2);
  }

  async function getPressureEstimate() {
    const latEl = $('latitude'), lonEl = $('longitude'),
          elevEl = $('elevation'), presEl = $('pressure'), statusEl = $('status');

    const safeSet = (el, text) => { if (el) el.textContent = text; };

    if (!navigator.geolocation) {
      safeSet(statusEl, 'Geolocation not supported on this device.');
      return;
    }

    safeSet(statusEl, 'Requesting location…');

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude.toFixed(5);
      const lon = pos.coords.longitude.toFixed(5);

      safeSet(latEl, lat);
      safeSet(lonEl, lon);

      const apiUrl = `https://api.opentopodata.org/v1/srtm90m?locations=${encodeURIComponent(lat)},${encodeURIComponent(lon)}`;

      try {
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 8000); // 8s timeout

        const res = await fetch(apiUrl, { signal: controller.signal });
        clearTimeout(t);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        // Expect: { results: [{ elevation: number }], status: "OK" }
        if (!data || data.status !== 'OK' || !data.results || !data.results[0] || typeof data.results[0].elevation !== 'number') {
          throw new Error(`API status ${data?.status || 'unknown'} or bad payload`);
        }

        const elevationMeters = data.results[0].elevation;
        const elevationFeet = Math.round(elevationMeters * 3.28084);
        const pressure = estimatePressure(elevationMeters);

        safeSet(elevEl, `${elevationFeet} ft`);
        safeSet(presEl, `${pressure} hPa`);
        safeSet(statusEl, 'Done.');
      } catch (err) {
        console.error(err);
        safeSet(statusEl, 'Failed to retrieve elevation. Check location permission (While Using + Precise ON) and network.');
      }
    }, (err) => {
      console.error(err);
      safeSet(statusEl, 'Location denied or unavailable. Enable Location Services for the Home-Screen app (PWA).');
    }, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    });
  }
</script>
