<script>
  function estimatePressure(elevationMeters) {
    const seaLevelPressure = 1013.25; // hPa
    const pressure = seaLevelPressure * Math.pow((1 - (0.0065 * elevationMeters) / 288.15), 5.255);
    return pressure.toFixed(2);
  }

  async function getPressureEstimate() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported on this device.');
      return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude.toFixed(5);
      const lon = pos.coords.longitude.toFixed(5);

      document.getElementById('latitude').textContent = lat;
      document.getElementById('longitude').textContent = lon;

      const apiUrl = `https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lon}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        console.log("Full elevation response:", data);

        if (
          !data ||
          !data.results ||
          !Array.isArray(data.results) ||
          data.results.length === 0 ||
          typeof data.results[0].elevation !== 'number'
        ) {
          throw new Error("Elevation data unavailable.");
        }

        const elevationMeters = data.results[0].elevation;
        const elevationFeet = (elevationMeters * 3.28084).toFixed(0);
        const pressure = estimatePressure(elevationMeters);

        document.getElementById('elevation').textContent = `${elevationFeet} ft`;
        document.getElementById('pressure').textContent = `${pressure} hPa`;

      } catch (err) {
        console.error(err);
        alert("Failed to retrieve elevation data. Please make sure Location Services are enabled in Safari settings.");
      }
    }, (err) => {
      console.error(err);
      alert("Unable to retrieve location. Please enable Location Services for Safari in iPhone settings.");
    });
  }
</script>
